# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

TxtPocket is a minimal text snippet manager built with Flutter for Windows and macOS. It launches directly into a frameless window with a quick launcher interface for managing and copying text snippets with usage tracking.

## Development Commands

### Setup & Dependencies
```bash
# Install dependencies
flutter pub get

# Generate Isar database files (required after modifying models/snippet.dart)
flutter pub run build_runner build --delete-conflicting-outputs

# Clean generated files (use when build_runner has issues)
flutter clean && flutter pub get && flutter pub run build_runner build --delete-conflicting-outputs
```

### Running & Testing
```bash
# Run on Windows
flutter run -d windows

# Run on macOS
flutter run -d macos

# Run tests
flutter test

# Check for issues
flutter doctor
```

## Architecture

### Database Layer (Isar NoSQL)
- **Model**: `lib/models/snippet.dart` defines the Snippet collection with Isar annotations
- **Generated Code**: `snippet.g.dart` is auto-generated by build_runner - never edit manually
- **Service**: `lib/services/database_service.dart` implements singleton pattern for database access
- Database location: User's Documents folder
- Sample data auto-loads on first run (7 example snippets)

### Key Architectural Patterns
1. **Singleton Database Service**: `DatabaseService()` always returns the same instance
2. **Reactive Search**: `searchSnippets()` returns a `Stream<List<Snippet>>` for real-time UI updates
3. **Usage Tracking**: Snippets are automatically sorted by `usageCount` (descending) then `lastUsedAt`
4. **Frameless Window**: Uses `window_manager` package to create a borderless window with custom size (600x500) that launches directly into the search interface
5. **Direct Launch**: App starts immediately in search mode without any intermediate UI or button clicks

### Widget Structure
- `main.dart`: App entry point with window_manager initialization, frameless window configuration, database initialization
- `widgets/launcher_widget.dart`: Main UI with two modes:
  - **Search Mode**: Fuzzy search through snippets, keyboard navigation, clipboard copy
  - **Add Mode**: Form for creating new snippets
- Focus management and keyboard shortcuts handled via FocusNode and KeyboardListener
- ESC key closes the application (via `windowManager.close()`)

### Data Flow
1. App launches → frameless window appears → `LauncherWidget` mounts → search focus activated (via post-frame callback)
2. Search input → `DatabaseService.searchSnippets()` stream updates
3. Snippet selection → `ClipboardService.copyToClipboard()` → `DatabaseService.incrementUsage()` → app closes
4. Isar stream automatically updates UI when data changes

## Important Notes

### Isar Code Generation
- Any changes to `@collection` classes require running build_runner
- Always use `--delete-conflicting-outputs` flag to handle conflicts
- Build runner must complete successfully before running the app

### Platform-Specific Requirements

#### Windows
- Developer Mode must be enabled on Windows 10/11
- This is non-negotiable for Flutter Windows apps with plugins
- See SETUP.md for enabling instructions

#### macOS
- Xcode 13+ required for builds
- CocoaPods used for dependency management (Podfile in macos/)
- Menu bar integration via AppDelegate.swift
- Background app mode configurable via LSUIElement in Info.plist
- When LSUIElement is set to true, app runs without dock icon
- Menu bar provides "Show TxtPocket" and "Quit" options

### Keyboard Shortcuts Implementation
- Global shortcuts (ESC) work in both modes
- Mode-specific shortcuts checked via `HardwareKeyboard.instance.isControlPressed`
- Arrow keys for navigation, Enter for selection in search mode
- Ctrl+N switches to add mode, Ctrl+Enter saves in add mode

### State Management
- No external state management library used
- StatefulWidget with setState for UI updates
- Isar streams provide reactive data layer
- Focus nodes manage keyboard input routing

### Focus Management
- Focus requests are deferred using `WidgetsBinding.instance.addPostFrameCallback` to avoid layout issues
- This ensures the widget tree is fully laid out before attempting to focus text fields
- Critical for preventing "RenderBox was not laid out" errors

## Platform-Specific Implementation Details

### macOS-Specific Files
- **macos/Runner/AppDelegate.swift**: Handles app lifecycle, menu bar setup, window show/hide
- **macos/Runner/Info.plist**: Contains LSUIElement flag for background app mode
- **macos/Podfile**: CocoaPods dependency configuration
- **macos/Podfile.lock**: Locked dependency versions (auto-generated)

### Cross-Platform Considerations
- Database path resolution works on both Windows and macOS via path_provider
- Window manager configuration uses platform-agnostic APIs
- Keyboard shortcuts use platform-independent Flutter APIs
- UI remains consistent across platforms while respecting native conventions
